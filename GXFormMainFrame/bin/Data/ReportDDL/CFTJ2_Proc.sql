create PROCEDURE [dbo].[SP_STAT_CF_LMXJCC](@tj nvarchar(max)) AS declare @year varchar(4) declare yearcursor cursor for select top 1 reportyear from t_stat_report open yearcursor fetch next from yearcursor into @year close yearcursor DEALLOCATE yearcursor delete from T_STAT_CF_LMXJCC insert into T_STAT_CF_LMXJCC(XIAN,XIANNAME,XIANG,XIANGNAME,CUN,CUNNAME,LB,LBNAME,DCB,DCBNAME,ZYXB,ZYXBNAME,BZDH,bzmj,SZ,SZNAME,JJ,JCLX,JCLXNAME,PJXJ,PJSG,YCSJCZS,BYCSJCZS,XCSJCZS,YCSXJL,BYCSXJL,XCSXJL,GGCCCLV,XCCCLV,GGCCCL,XCCCL,PARAMS) exec('select c.xian,c.xianname,c.xiang,c.xiangname,a.cun,(select cname from t_sys_meta_code b where a.cun=b.CCODE and b.cindex=''105''),a.LIN_BAN,a.LIN_BAN,DCXB,DCXB,ZYXB,ZYXB,BZDH,BZDMJ,JCSZ,(select cname from t_sys_meta_code b where jcsz=b.CCODE and b.cindex=''219''),JJ,JCLX,(select cname from t_sys_meta_code b where JCLX=b.CCODE and b.cindex=''255''),PJZJ,PJG,YCZS,BYCZS,XCZS,YCXJ,BYCXJ,XCXJ,GGCCCLV,XCCCLV,GGCCCL,XCCCL,0 FROM T_ZT_CF_MMJC a inner join (select XIAN,xiang,cun,(select cname from t_sys_meta_code b where XIAN=b.CCODE and b.cindex=''103'') as xianname,(select cname from t_sys_meta_code b where XIANG=b.CCODE and b.cindex=''104'') as xiangname,LIN_BAN,XIAO_BAN,XI_BAN from ZT_CF_'+@YEAR+' where '+@tj+' group by xian,xiang,cun,LIN_BAN,XIAO_BAN,XI_BAN)c on a.cun=c.cun where a.LIN_BAN=c.LIN_BAN and a.DCXB=c.XIAO_BAN and a.ZYXB=c.XI_BAN') insert into T_STAT_CF_LMXJCC(xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ,SZ,JJ,JCLXNAME,YCSJCZS,YCSXJL,GGCCCL,XCCCL,PARAMS) select xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ,sz,'合计',(select cname from t_sys_meta_code b where JCLX=b.CCODE and b.cindex='255'),SUM(YCSJCZS),sum(YCSXJL),sum(GGCCCL),sum(XCCCL),1 from T_STAT_CF_LMXJCC group by xian,xianname,XIANg,xiangname,CUN,cunname,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ,SZ,JCLX insert into T_STAT_CF_LMXJCC(XIAN,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,SZ,JJ,JCLXNAME,YCSXJL,GGCCCL,XCCCL,PARAMS) select xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,sz,'公顷',JCLXNAME,YCSXJL*10000/case bzmj when 0 then null else bzmj end,GGCCCL*10000/case bzmj when 0 then null else bzmj end,XCCCL*10000/case bzmj when 0 then null else bzmj end,2 from T_STAT_CF_LMXJCC where PARAMS=1 insert into T_STAT_CF_LMXJCC(xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ,PARAMS) select xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ,3 from T_STAT_CF_LMXJCC where params=0 group by xian,XIANNAME,xiang,XIANGNAME,cun,CUNNAME,LB,lbname,DCB,dcbname,ZYXB,zyxbname,BZDH,BZMJ