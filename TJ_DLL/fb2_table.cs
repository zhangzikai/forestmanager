namespace Tj
{
    using System;
    using System.Data;
    using System.Data.SqlClient;
    using System.Windows.Forms;

    internal class fb2_table
    {
        public void Export_Table2(string pXBTableName, string pCodeTableName, string pConnecting)
        {
            SqlConnection connection = new SqlConnection();
            string str = pConnecting;
            connection.ConnectionString = str;
            connection.Open();
            SqlCommand selectCommand = new SqlCommand(" select t.*,mj.土地总面积,'' as 覆盖率增减量 from ( select case when code.cname IS null then '合计' else code.CNAME end as 统计单位, case when (GROUPING (XIANG) = 1) then '合计' else ISNULL(XIANG,'1') end as tjdw, case when (GROUPING (地类) = 1) then '合计' else ISNULL(地类,'') end as 类型, sum(前期面积) as 前期面积, '' as 前期覆盖率, sum(增加合计) as 增加合计,sum(宜林地或其他无立林地) as 宜林地或其他无立林地, sum(迹地更新) as 迹地更新,sum(未成林转化) as 未成林转化,sum(农地造林) as 农地造林, sum(四旁增加) as 四旁增加,sum(其它增加) as 其它增加,sum(减少合计) as 减少合计, sum(皆伐改造) as 皆伐改造,sum(虫灾火灾) as 虫灾火灾,sum(盗伐滥伐) as 盗伐滥伐, sum(占用征收林地) as 占用征收林地,sum(砍伐四旁树) as 砍伐四旁树, sum(其它减少) as 其它减少,sum(本期面积) as 本期面积,'' as 本期覆盖率 from ( select xiang ,'有林地' as 地类, SUM(case when Q_DI_LEI < '200' then convert(decimal(18,1),yxmj) else 0 end) as 前期面积, sum(case when (((DI_LEI < '200' and Q_DI_LEI >= '200') or (DI_LEI < '200' and Q_DI_LEI < '200' and BHYY <> '80' and BHYY IS not null ))) then convert(decimal(18,1),yxmj) else 0 end) as 增加合计, sum(case when (Q_DI_LEI like '7%' OR Q_DI_LEI LIKE '603%') and (DI_LEI <'200') and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 宜林地或其他无立林地, sum(case when ((Q_DI_LEI like '6%' and Q_DI_LEI not like '603%') OR (Q_DI_LEI < '200')) and (DI_LEI <'200') and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 迹地更新, sum(case when Q_DI_LEI like '4%' and (DI_LEI <'200') then convert(decimal(18,1),yxmj) else 0 end) as 未成林转化, 0 as 农地造林, 0 as 四旁增加, sum(case when not(((DI_LEI < '200' and Q_DI_LEI >= '200') or (DI_LEI < '200' and Q_DI_LEI < '200' and BHYY <> '80' and BHYY IS not null )) and Q_DI_LEI < '900' and Q_DI_LEI not like '3%') and Q_DI_LEI >= '200' and DI_LEI < '200' then convert(decimal(18,1),yxmj) else 0 end) as 其它增加,  sum(case when (((Q_DI_LEI < '200' and DI_LEI >= '200') and BHYY IS not null) or ((Q_DI_LEI < '200' and DI_LEI <'200') and BHYY <> '80' and BHYY IS not null)) then convert(decimal(18,1),yxmj) else 0 end) as 减少合计, sum(case when Q_DI_LEI < '200' and (DI_LEI <='500') and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 皆伐改造, sum(case when Q_DI_LEI < '200' and DI_LEI >='200' and BHYY like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 虫灾火灾, 0 as 盗伐滥伐, sum(case when Q_DI_LEI < '200' and DI_LEI >='200' and BHYY like '4%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 占用征收林地, 0 as 砍伐四旁树, sum(case when (((Q_DI_LEI < '200' and DI_LEI >= '200') and BHYY IS not null) or ((Q_DI_LEI < '200' and DI_LEI <'200') and BHYY <> '80' and BHYY IS not null)) and not(Q_DI_LEI < '200' and (DI_LEI <='500') and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null) and not(Q_DI_LEI < '200' and DI_LEI >='200' and BHYY like '7%' and BHYY IS not null) and not(Q_DI_LEI < '200' and DI_LEI >='200' and BHYY like '4%' and BHYY IS not null) then convert(decimal(18,1),yxmj) else 0 end) as 其它减少, SUM(case when DI_LEI < '200' then convert(decimal(18,1),yxmj) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG)  union all  select xiang ,'国灌' as 地类, SUM(case when Q_DI_LEI = '301' then convert(decimal(18,1),yxmj) else 0 end) as 前期面积, sum(case when (((DI_LEI = '301' and Q_DI_LEI <> '301') or (DI_LEI = '301' and Q_DI_LEI = '301' and BHYY <> '80' and BHYY IS not null ))) then convert(decimal(18,1),yxmj) else 0 end) as 增加合计, sum(case when (Q_DI_LEI like '7%' OR Q_DI_LEI LIKE '603%') and (DI_LEI ='301') and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 宜林地或其他无立林地, sum(case when ((Q_DI_LEI like '6%' and Q_DI_LEI not like '603%') OR (Q_DI_LEI <= '301')) and (DI_LEI ='301') and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 迹地更新, sum(case when Q_DI_LEI like '4%' and (DI_LEI = '301') then convert(decimal(18,1),yxmj) else 0 end) as 未成林转化, 0 as 农地造林, 0 as 四旁增加, sum(case when not(((DI_LEI = '301' and Q_DI_LEI <> '301') or (DI_LEI = '301' and Q_DI_LEI = '301' and BHYY <> '80' and BHYY IS not null )) and Q_DI_LEI < '900') and Q_DI_LEI <> '301' and DI_LEI = '301'  then convert(decimal(18,1),yxmj) else 0 end) as 其它增加,  sum(case when (((Q_DI_LEI = '301' and DI_LEI <> '301') and BHYY IS not null) or ((Q_DI_LEI = '301' and DI_LEI ='301') and BHYY <> '80' and BHYY IS not null)) then convert(decimal(18,1),yxmj) else 0 end) as 减少合计, sum(case when Q_DI_LEI = '301' and (DI_LEI <>'301') and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 皆伐改造, sum(case when Q_DI_LEI = '301' and DI_LEI <>'301' and BHYY like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 虫灾火灾, 0 as 盗伐滥伐, sum(case when Q_DI_LEI = '301' and DI_LEI <>'301' and BHYY like '4%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 占用征收林地, 0 as 砍伐四旁树, sum(case when (((Q_DI_LEI = '301' and DI_LEI <> '301') and BHYY IS not null) or ((Q_DI_LEI = '301' and DI_LEI ='301') and BHYY <> '80' and BHYY IS not null)) and not(Q_DI_LEI = '301' and (DI_LEI <>'301') and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null) and not(Q_DI_LEI = '301' and DI_LEI <>'301' and BHYY like '7%' and BHYY IS not null) and not(Q_DI_LEI = '301' and DI_LEI <>'301' and BHYY like '4%' and BHYY IS not null) then convert(decimal(18,1),yxmj) else 0 end) as 其它减少, SUM(case when DI_LEI = '301' then convert(decimal(18,1),yxmj) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG)  union all  select xiang ,'农地乔木林' as 地类, SUM(case when Q_DI_LEI = '961' then convert(decimal(18,1),yxmj) else 0 end) as 前期面积, sum(case when ((DI_LEI = '961' and Q_DI_LEI <> '961') or (DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 增加合计, 0 as 宜林地或其他无立林地, sum(case when DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 迹地更新, 0 as 未成林转化, sum(case when DI_LEI = '961' and Q_DI_LEI <> '961' and Q_DI_LEI like '9%' then convert(decimal(18,1),yxmj) else 0 end) as 农地造林, 0 as 四旁增加, sum(case when ((DI_LEI = '961' and Q_DI_LEI <> '961') or (DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY IS not null )) and Q_DI_LEI < '900' then convert(decimal(18,1),yxmj) else 0 end) as 其它增加,  sum(case when ((DI_LEI <> '961' and Q_DI_LEI = '961') or (DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 减少合计, sum(case when (DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) then convert(decimal(18,1),yxmj) else 0 end)as 皆伐改造, sum(case when (DI_LEI <> '961' and Q_DI_LEI = '961') and BHYY like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 虫灾火灾, 0 as 盗伐滥伐, sum(case when (DI_LEI <> '961' and Q_DI_LEI = '961') and BHYY like '4%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 占用征收林地, 0 as 砍伐四旁树, sum(case when ((DI_LEI <> '961' and Q_DI_LEI = '961') or (DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY IS not null )) and not(DI_LEI = '961' and Q_DI_LEI = '961' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) and not((DI_LEI <> '961' and Q_DI_LEI = '961') and BHYY like '7%' and BHYY IS not null) and not((DI_LEI <> '961' and Q_DI_LEI = '961') and BHYY like '4%' and BHYY IS not null) then convert(decimal(18,1),yxmj) else 0 end) as 其它减少, SUM(case when DI_LEI = '961' then convert(decimal(18,1),yxmj) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG)  union all  select xiang ,'农地经济林' as 地类, SUM(case when Q_DI_LEI = '962' then convert(decimal(18,1),yxmj) else 0 end) as 前期面积, sum(case when ((DI_LEI = '962' and Q_DI_LEI <> '962') or (DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 增加合计, 0 as 宜林地或其他无立林地, sum(case when DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 迹地更新, 0 as 未成林转化, sum(case when DI_LEI = '962' and Q_DI_LEI <> '962' and Q_DI_LEI like '9%' then convert(decimal(18,1),yxmj) else 0 end) as 农地造林, 0 as 四旁增加, sum(case when ((DI_LEI = '962' and Q_DI_LEI <> '962') or (DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY IS not null )) and Q_DI_LEI < '900' then convert(decimal(18,1),yxmj) else 0 end) as 其它增加,  sum(case when ((DI_LEI <> '962' and Q_DI_LEI = '962') or (DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 减少合计, sum(case when (DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) then convert(decimal(18,1),yxmj) else 0 end)as 皆伐改造, sum(case when (DI_LEI <> '962' and Q_DI_LEI = '962') and BHYY like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 虫灾火灾, 0 as 盗伐滥伐, sum(case when (DI_LEI <> '962' and Q_DI_LEI = '962') and BHYY like '4%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 占用征收林地, 0 as 砍伐四旁树, sum(case when ((DI_LEI <> '962' and Q_DI_LEI = '962') or (DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY IS not null )) and not(DI_LEI = '962' and Q_DI_LEI = '962' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) and not((DI_LEI <> '962' and Q_DI_LEI = '962') and BHYY like '7%' and BHYY IS not null) and not((DI_LEI <> '962' and Q_DI_LEI = '962') and BHYY like '4%' and BHYY IS not null) then convert(decimal(18,1),yxmj) else 0 end) as 其它减少, SUM(case when DI_LEI = '962' then convert(decimal(18,1),yxmj) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG)  union all  select xiang ,'农地竹林' as 地类, SUM(case when Q_DI_LEI = '963' then convert(decimal(18,1),yxmj) else 0 end) as 前期面积, sum(case when ((DI_LEI = '963' and Q_DI_LEI <> '963') or (DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 增加合计, 0 as 宜林地或其他无立林地, sum(case when DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end) as 迹地更新, 0 as 未成林转化, sum(case when DI_LEI = '963' and Q_DI_LEI <> '963' and Q_DI_LEI like '9%' then convert(decimal(18,1),yxmj) else 0 end) as 农地造林, 0 as 四旁增加, sum(case when ((DI_LEI = '963' and Q_DI_LEI <> '963') or (DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY IS not null )) and Q_DI_LEI < '900' then convert(decimal(18,1),yxmj) else 0 end) as 其它增加,  sum(case when ((DI_LEI <> '963' and Q_DI_LEI = '963') or (DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY IS not null )) then convert(decimal(18,1),yxmj) else 0 end) as 减少合计, sum(case when (DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) then convert(decimal(18,1),yxmj) else 0 end)as 皆伐改造, sum(case when (DI_LEI <> '963' and Q_DI_LEI = '963') and BHYY like '7%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 虫灾火灾, 0 as 盗伐滥伐, sum(case when (DI_LEI <> '963' and Q_DI_LEI = '963') and BHYY like '4%' and BHYY IS not null then convert(decimal(18,1),yxmj) else 0 end)as 占用征收林地, 0 as 砍伐四旁树, sum(case when ((DI_LEI <> '963' and Q_DI_LEI = '963') or (DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY IS not null )) and not(DI_LEI = '963' and Q_DI_LEI = '963' and BHYY <> '80' and BHYY not like '4%' and BHYY not like '7%' and BHYY IS not null ) and not((DI_LEI <> '963' and Q_DI_LEI = '963') and BHYY like '7%' and BHYY IS not null) and not((DI_LEI <> '963' and Q_DI_LEI = '963') and BHYY like '4%' and BHYY IS not null) then convert(decimal(18,1),yxmj) else 0 end) as 其它减少, SUM(case when DI_LEI = '963' then convert(decimal(18,1),yxmj) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG)  union all  select xiang ,'四旁绿化面积' as 地类, SUM(case when SSLX  = '2' then convert(decimal(18,1),(CAST((ISNULL(BAK1,0)) AS NUMERIC(38,1))/cast(1650 as float))) else 0 end) as 前期面积, SUM(CASE WHEN ISNULL(SSZZS,0)>ISNULL(BAK1,0) AND ISNULL(SSLX,0)='2' AND DI_LEI LIKE '9%' THEN convert(decimal(18,1),(CAST((ISNULL(SSZZS,0)-ISNULL(BAK1,0)) AS NUMERIC(38,1))/1650)) ELSE 0 END) as 增加合计, 0 as 宜林地或其他无立林地, 0 as 迹地更新, 0 as 未成林转化, 0 as 农地造林, SUM(CASE WHEN ISNULL(SSZZS,0)>ISNULL(BAK1,0) AND ISNULL(SSLX,0)='2' AND DI_LEI LIKE '9%' THEN convert(decimal(18,1),(CAST((ISNULL(SSZZS,0)-ISNULL(BAK1,0)) AS NUMERIC(38,1))/1650)) ELSE 0 END) as 四旁增加, 0 as 其它增加,  SUM(CASE WHEN ISNULL(SSZZS,0)<ISNULL(BAK1,0) AND ISNULL(SSLX,0)='2' AND DI_LEI LIKE '9%' THEN convert(decimal(18,1),CAST((ISNULL(BAK1,0)-ISNULL(SSZZS,0)) AS NUMERIC(38,1))/1650 ) ELSE 0 END)  as 减少合计, 0 as 皆伐改造, 0 as 虫灾火灾, 0 as 盗伐滥伐, 0 as 占用征收林地, SUM(CASE WHEN ISNULL(SSZZS,0)<ISNULL(BAK1,0) AND ISNULL(SSLX,0)='2' AND DI_LEI LIKE '9%' THEN convert(decimal(18,1),CAST((ISNULL(BAK1,0)-ISNULL(SSZZS,0)) AS NUMERIC(38,1))/1650 ) ELSE 0 END)  as 砍伐四旁树, 0 as 其它减少, SUM(case when SSLX  = '2' then convert(decimal(18,1),(CAST((ISNULL(SSZZS,0)) AS NUMERIC(38,1))/cast(1650 as float))) else 0 end) as 本期面积 from " + pXBTableName + " group by cube(XIANG) )as bb left join " + pCodeTableName + " as code  on bb.XIANG = code.CCODE and CTYPE = '乡' group by bb.XIANG,cube(bb.地类),code.CNAME  ) as t left join  (select case when (GROUPING (XIANG) = 1) then 1 else ISNULL(XIANG,'') end as tjdw, sum(convert(decimal(18,1),mian_ji)) as 土地总面积,'合计' as bb  from " + pXBTableName + " group by cube(xiang) ) as mj on t.tjdw = mj.tjdw and t.类型 = mj.bb order by t.tjdw , case when t.类型 ='有林地' then 1 when t.类型 ='国灌' then 2 when t.类型 ='农地乔木林' then 3 when t.类型 ='农地经济林' then 4 when t.类型 ='农地竹林' then 5 when t.类型 ='四旁绿化面积' then 6 end", connection);
            selectCommand.CommandTimeout = 60;
            SqlDataAdapter adapter = new SqlDataAdapter(selectCommand);
            connection.Close();
            DataTable dataTable = new DataTable();
            adapter.Fill(dataTable);
            for (int i = 0; i < dataTable.Rows.Count; i++)
            {
                if (dataTable.Rows[i]["类型"].ToString().Trim() == "合计")
                {
                    dataTable.Rows[i]["前期覆盖率"] = ((double.Parse(dataTable.Rows[i]["前期面积"].ToString().Trim()) / double.Parse(dataTable.Rows[i]["土地总面积"].ToString().Trim())) * 100.0).ToString("0.00");
                    dataTable.Rows[i]["本期覆盖率"] = ((double.Parse(dataTable.Rows[i]["本期面积"].ToString().Trim()) / double.Parse(dataTable.Rows[i]["土地总面积"].ToString().Trim())) * 100.0).ToString("0.00");
                    dataTable.Rows[i]["覆盖率增减量"] = (double.Parse(dataTable.Rows[i]["本期覆盖率"].ToString()) - double.Parse(dataTable.Rows[i]["前期覆盖率"].ToString())).ToString("0.00");
                }
            }
            dataTable.Columns.Remove("tjdw");
            dataTable.Columns.Remove("土地总面积");
            for (int j = 0; j < dataTable.Rows.Count; j++)
            {
                for (int k = 0; k < dataTable.Columns.Count; k++)
                {
                    if (((dataTable.Rows[j][k].ToString().Trim() == "0.00") || (dataTable.Rows[j][k].ToString().Trim() == "0.0")) || (dataTable.Rows[j][k].ToString().Trim() == "0"))
                    {
                        dataTable.Rows[j][k] = DBNull.Value;
                    }
                }
            }
            MessageBox.Show(dataTable.Rows.Count.ToString());
        }
    }
}

